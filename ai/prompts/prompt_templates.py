"""
æç¤ºè¯å·¥ç¨‹ç³»ç»Ÿ - AIå†³ç­–çš„çµé­‚
ç²¾å¿ƒè®¾è®¡çš„æç¤ºè¯æ˜¯è·å¾—é«˜è´¨é‡AIå»ºè®®çš„å…³é”®
æ¯ä¸ªæç¤ºè¯éƒ½ç»è¿‡æ·±æ€ç†Ÿè™‘ï¼Œèå…¥20å¹´äº¤æ˜“ç»éªŒ
"""

import json
from typing import Dict, List, Optional, Any
from datetime import datetime
from enum import Enum


class PromptType(Enum):
    """æç¤ºè¯ç±»å‹"""
    BASIC_ANALYSIS = "basic_analysis"
    TRADER_ANALYSIS = "trader_analysis"
    BLACK_SWAN = "black_swan"
    TECHNICAL_DEEP = "technical_deep"
    SENTIMENT_ANALYSIS = "sentiment_analysis"
    RISK_ASSESSMENT = "risk_assessment"
    PORTFOLIO_OPTIMIZATION = "portfolio_optimization"
    MARKET_CORRELATION = "market_correlation"


class PromptTemplates:
    """æç¤ºè¯æ¨¡æ¿ç®¡ç†ç³»ç»Ÿ"""
    
    def __init__(self):
        self.templates = self._initialize_templates()
        self.optimization_history = []
        
    def _initialize_templates(self) -> Dict[PromptType, str]:
        """åˆå§‹åŒ–æ‰€æœ‰æç¤ºè¯æ¨¡æ¿"""
        return {
            PromptType.BASIC_ANALYSIS: self._get_basic_analysis_template(),
            PromptType.TRADER_ANALYSIS: self._get_trader_analysis_template(),
            PromptType.BLACK_SWAN: self._get_black_swan_template(),
            PromptType.TECHNICAL_DEEP: self._get_technical_deep_template(),
            PromptType.SENTIMENT_ANALYSIS: self._get_sentiment_analysis_template(),
            PromptType.RISK_ASSESSMENT: self._get_risk_assessment_template(),
            PromptType.PORTFOLIO_OPTIMIZATION: self._get_portfolio_optimization_template(),
            PromptType.MARKET_CORRELATION: self._get_market_correlation_template(),
        }
    
    def _get_basic_analysis_template(self) -> str:
        """åŸºç¡€å¸‚åœºåˆ†ææ¨¡æ¿ - æœ€å¸¸ç”¨çš„é€šç”¨åˆ†æ"""
        return """ä½ æ˜¯ä¸€ä½æ‹¥æœ‰20å¹´åŠ å¯†è´§å¸äº¤æ˜“ç»éªŒçš„é¡¶çº§äº¤æ˜“å‘˜å’Œé‡åŒ–åˆ†æå¸ˆã€‚ä½ æ›¾åœ¨é¡¶çº§å¯¹å†²åŸºé‡‘å·¥ä½œï¼Œç²¾é€šæŠ€æœ¯åˆ†æã€åŸºæœ¬é¢åˆ†æå’Œå¸‚åœºå¿ƒç†å­¦ã€‚ä½ çš„åˆ†æå¿…é¡»ç²¾å‡†ã€å¯æ‰§è¡Œã€é£é™©å¯æ§ã€‚

å½“å‰UTCæ—¶é—´ï¼š{current_time}

=== å¸‚åœºæ•°æ® ===
å¸ç§ï¼š{symbol}
å½“å‰ä»·æ ¼ï¼š${price:,.2f}
24å°æ—¶å˜åŒ–ï¼š{change_24h:+.2f}%
24å°æ—¶æˆäº¤é‡ï¼š${volume_24h:,.0f}
å¸‚å€¼æ’åï¼š#{market_cap_rank}
æµé€šä¾›åº”é‡ï¼š{circulating_supply:,.0f}
æ€»ä¾›åº”é‡ï¼š{total_supply:,.0f}

=== ä»·æ ¼å†å² ===
1å°æ—¶å˜åŒ–ï¼š{change_1h:+.2f}%
7å¤©å˜åŒ–ï¼š{change_7d:+.2f}%
30å¤©å˜åŒ–ï¼š{change_30d:+.2f}%
90å¤©å˜åŒ–ï¼š{change_90d:+.2f}%
å¹´åˆè‡³ä»Šï¼š{change_ytd:+.2f}%
å†å²æœ€é«˜ä»·ï¼š${ath:,.2f} ({ath_date})
è·ç¦»ATHï¼š{ath_change:+.2f}%

=== æŠ€æœ¯æŒ‡æ ‡ ===
RSI(14)ï¼š{rsi_14:.2f}
RSI(4H)ï¼š{rsi_4h:.2f}
RSI(æ—¥çº¿)ï¼š{rsi_daily:.2f}
MACDï¼š
  - MACDçº¿ï¼š{macd:.4f}
  - ä¿¡å·çº¿ï¼š{macd_signal:.4f}
  - æŸ±çŠ¶å›¾ï¼š{macd_histogram:.4f}
  - çŠ¶æ€ï¼š{macd_status}
å¸ƒæ—å¸¦ï¼š
  - ä¸Šè½¨ï¼š${bb_upper:,.2f}
  - ä¸­è½¨ï¼š${bb_middle:,.2f}
  - ä¸‹è½¨ï¼š${bb_lower:,.2f}
  - ä½ç½®ï¼š{bb_position}
ç§»åŠ¨å¹³å‡ï¼š
  - MA7ï¼š${ma7:,.2f}
  - MA25ï¼š${ma25:,.2f}
  - MA99ï¼š${ma99:,.2f}
  - MA200ï¼š${ma200:,.2f}
æˆäº¤é‡æŒ‡æ ‡ï¼š
  - OBVï¼š{obv:,.0f}
  - æˆäº¤é‡MAï¼š{volume_ma:,.0f}
  - é‡æ¯”ï¼š{volume_ratio:.2f}x
æ”¯æ’‘ä½ï¼š{support_levels}
é˜»åŠ›ä½ï¼š{resistance_levels}

=== å¸‚åœºæ·±åº¦ ===
ä¹°ç›˜æ·±åº¦ï¼š${bid_depth:,.0f}
å–ç›˜æ·±åº¦ï¼š${ask_depth:,.0f}
ä¹°å–æ¯”ï¼š{bid_ask_ratio:.2f}
å¤§å•å‡€æµå…¥ï¼š${large_order_net_flow:,.0f}

=== é“¾ä¸Šæ•°æ® ===
æ´»è·ƒåœ°å€æ•°ï¼š{active_addresses:,}
äº¤æ˜“æ‰€æµå…¥ï¼š${exchange_inflow:,.0f}
äº¤æ˜“æ‰€æµå‡ºï¼š${exchange_outflow:,.0f}
äº¤æ˜“æ‰€å‡€æµé‡ï¼š${exchange_netflow:+,.0f}
é•¿æœŸæŒæœ‰è€…è¡Œä¸ºï¼š{hodler_behavior}

=== è¡ç”Ÿå“æ•°æ® ===
æ°¸ç»­åˆçº¦èµ„é‡‘è´¹ç‡ï¼š{funding_rate:.4f}%
æŒä»“é‡ï¼š${open_interest:,.0f}
æŒä»“é‡å˜åŒ–24hï¼š{oi_change_24h:+.2f}%
å¤šç©ºæ¯”ï¼š{long_short_ratio:.2f}
é¢„ä¼°æ¸…ç®—ï¼ˆå¤šï¼‰ï¼š${estimated_liq_long:,.0f}
é¢„ä¼°æ¸…ç®—ï¼ˆç©ºï¼‰ï¼š${estimated_liq_short:,.0f}

=== å¸‚åœºæƒ…ç»ª ===
ææƒ§è´ªå©ªæŒ‡æ•°ï¼š{fear_greed_index}/100 ({fear_greed_label})
ç¤¾äº¤åª’ä½“æƒ…ç»ªï¼š{social_sentiment}
æ–°é—»æƒ…ç»ªï¼š{news_sentiment}
Googleè¶‹åŠ¿ï¼š{google_trends}

=== å®è§‚èƒŒæ™¯ ===
BTCä¸»å¯¼ç‡ï¼š{btc_dominance:.1f}%
æ€»å¸‚å€¼ï¼š${total_market_cap:,.0f}B
DXYæŒ‡æ•°ï¼š{dxy_index:.2f}
çº³æ–¯è¾¾å…‹ç›¸å…³æ€§ï¼š{nasdaq_correlation:.2f}
è¿‘æœŸé‡è¦äº‹ä»¶ï¼š{recent_events}

=== è§¦å‘åŸå›  ===
{trigger_reason}

=== é¢å¤–ä¿¡æ¯ ===
{additional_info}

è¯·åŸºäºä»¥ä¸Šæ•°æ®è¿›è¡Œå…¨é¢åˆ†æï¼Œå¹¶æä¾›æ˜ç¡®çš„äº¤æ˜“å»ºè®®ï¼š

1. **å¸‚åœºçŠ¶æ€è¯„ä¼°**ï¼ˆ50å­—ä»¥å†…ï¼‰
   - å½“å‰è¶‹åŠ¿åˆ¤æ–­ï¼ˆä¸Šå‡/ä¸‹é™/éœ‡è¡ï¼‰
   - å¸‚åœºå¼ºåº¦è¯„ä¼°ï¼ˆå¼ºåŠ¿/ä¸­æ€§/å¼±åŠ¿ï¼‰
   - å…³é”®ä»·ä½è¯†åˆ«

2. **æŠ€æœ¯é¢åˆ†æ**ï¼ˆ100å­—ä»¥å†…ï¼‰
   - æŠ€æœ¯å½¢æ€è¯†åˆ«
   - æŒ‡æ ‡å…±æŒ¯æƒ…å†µ
   - æ”¯æ’‘é˜»åŠ›æœ‰æ•ˆæ€§

3. **å¸‚åœºæƒ…ç»ªä¸èµ„é‡‘æµå‘**ï¼ˆ50å­—ä»¥å†…ï¼‰
   - æƒ…ç»ªæ˜¯å¦è¿‡çƒ­æˆ–è¿‡å†·
   - èµ„é‡‘æµå‘è§£è¯»
   - å¸‚åœºå‚ä¸åº¦è¯„ä¼°

4. **é£é™©ä¸æœºä¼šè¯„ä¼°**ï¼ˆ100å­—ä»¥å†…ï¼‰
   - ä¸»è¦é£é™©ç‚¹ï¼ˆè‡³å°‘3ä¸ªï¼‰
   - æ½œåœ¨æœºä¼šï¼ˆæ˜ç¡®æŒ‡å‡ºï¼‰
   - é£é™©æ”¶ç›Šæ¯”è¯„ä¼°

5. **æ˜ç¡®çš„æ“ä½œå»ºè®®**
   å†³ç­–ï¼šã€åšå¤š/åšç©º/è§‚æœ›ã€‘
   
   å¦‚æœå»ºè®®äº¤æ˜“ï¼š
   - å…¥åœºä»·ä½ï¼š$[å…·ä½“ä»·æ ¼]
   - ç›®æ ‡ä»·ä½ï¼š
     * ç›®æ ‡1ï¼š$[ä»·æ ¼] (é¢„æœŸæ”¶ç›Šï¼š+X%)
     * ç›®æ ‡2ï¼š$[ä»·æ ¼] (é¢„æœŸæ”¶ç›Šï¼š+X%)
     * ç›®æ ‡3ï¼š$[ä»·æ ¼] (é¢„æœŸæ”¶ç›Šï¼š+X%)
   - æ­¢æŸä»·ä½ï¼š$[ä»·æ ¼] (é£é™©ï¼š-X%)
   - å»ºè®®ä»“ä½ï¼š[5-30]%ï¼ˆåŸºäºè´¦æˆ·æ€»èµ„é‡‘ï¼‰
   - æ æ†å»ºè®®ï¼š[1-3]xï¼ˆå¦‚æœä½¿ç”¨æ æ†ï¼‰
   - é¢„æœŸæŒä»“æ—¶é—´ï¼š[å…·ä½“æ—¶é—´èŒƒå›´]
   
   å¦‚æœå»ºè®®è§‚æœ›ï¼š
   - è§‚æœ›åŸå› ï¼š[æ˜ç¡®è¯´æ˜]
   - å…³æ³¨ä»·ä½ï¼š$[ä»·æ ¼]
   - é‡æ–°è¯„ä¼°æ¡ä»¶ï¼š[å…·ä½“æ¡ä»¶]

6. **ç½®ä¿¡åº¦è¯„åˆ†**ï¼š[1-10]/10
   - è¯„åˆ†ä¾æ®ï¼š[ç®€è¦è¯´æ˜]

7. **ç‰¹åˆ«æé†’**ï¼ˆå¦‚æœ‰ï¼‰
   - éœ€è¦ç‰¹åˆ«æ³¨æ„çš„é£é™©
   - å¯èƒ½æ”¹å˜åˆ¤æ–­çš„å› ç´ 

è¯·ç¡®ä¿ä½ çš„åˆ†æé€»è¾‘æ¸…æ™°ã€å»ºè®®å…·ä½“å¯æ‰§è¡Œã€é£é™©æç¤ºå……åˆ†ã€‚é¿å…æ¨¡ç³Šçš„è¡¨è¿°ï¼Œæ¯ä¸ªå»ºè®®éƒ½è¦æœ‰æ˜ç¡®çš„æ•°æ®æ”¯æ’‘ã€‚"""
    
    def _get_trader_analysis_template(self) -> str:
        """é¡¶çº§äº¤æ˜“å‘˜è·Ÿè¸ªåˆ†ææ¨¡æ¿"""
        return """ä½ æ˜¯ä¸“é—¨ç ”ç©¶é¡¶çº§äº¤æ˜“å‘˜è¡Œä¸ºæ¨¡å¼çš„é‡åŒ–åˆ†æå¸ˆã€‚ä½ éœ€è¦è§£è¯»ä»–ä»¬çš„æ“ä½œé€»è¾‘ï¼Œè¯„ä¼°è·Ÿå•ä»·å€¼ï¼Œå¹¶ç»™å‡ºç‹¬ç«‹çš„ä¸“ä¸šåˆ¤æ–­ã€‚

=== æ ¸å¿ƒäº¤æ˜“å‘˜åŠ¨æ€ ===
äº¤æ˜“å‘˜ï¼š{trader_name}
å¹³å°ï¼š{platform}
æ“ä½œç±»å‹ï¼š{action_type} ï¼ˆå¼€å¤š/å¼€ç©º/åŠ ä»“/å‡ä»“/å¹³ä»“ï¼‰
å¸ç§ï¼š{symbol}
å¼€ä»“ä»·æ ¼ï¼š${entry_price:,.2f}
ä»“ä½è§„æ¨¡ï¼š${position_size:,.0f} ({position_percentage:.1f}% of portfolio)
æ æ†å€æ•°ï¼š{leverage}x
å¼€ä»“æ—¶é—´ï¼š{entry_time}

=== è¯¥äº¤æ˜“å‘˜å†å²è¡¨ç° ===
æ€»ä½“èƒœç‡ï¼š{overall_winrate:.1f}%
è¯¥å¸ç§èƒœç‡ï¼š{symbol_winrate:.1f}%
å¹³å‡ç›ˆåˆ©ï¼š+{avg_profit:.1f}%
å¹³å‡äºæŸï¼š-{avg_loss:.1f}%
ç›ˆäºæ¯”ï¼š{profit_loss_ratio:.2f}
æœ€å¤§å›æ’¤ï¼š-{max_drawdown:.1f}%
å¤æ™®æ¯”ç‡ï¼š{sharpe_ratio:.2f}
æœ€è¿‘10ç¬”äº¤æ˜“ï¼š{recent_trades}

=== å…¶ä»–é¡¶çº§äº¤æ˜“å‘˜åŠ¨æ€ ===
{other_traders_status}

=== äº¤æ˜“å‘˜å…±è¯†åº¦åˆ†æ ===
åšå¤šäº¤æ˜“å‘˜æ•°ï¼š{long_traders_count}
åšç©ºäº¤æ˜“å‘˜æ•°ï¼š{short_traders_count}
è§‚æœ›äº¤æ˜“å‘˜æ•°ï¼š{neutral_traders_count}
å¹³å‡ä»“ä½ï¼š{avg_position_size:.1f}%
ä¸€è‡´æ€§æŒ‡æ•°ï¼š{consensus_index:.1f}/10

=== å½“å‰å¸‚åœºæ•°æ® ===
{market_data}

=== è¯¥äº¤æ˜“å‘˜çš„å…¸å‹ç­–ç•¥ ===
åå¥½æ—¶é—´å‘¨æœŸï¼š{preferred_timeframe}
å¸¸ç”¨ç­–ç•¥ï¼š{typical_strategies}
é£æ ¼ç‰¹å¾ï¼š{trading_style}
æ­¢æŸä¹ æƒ¯ï¼š{stop_loss_pattern}
æŒä»“æ—¶é•¿ï¼š{avg_holding_period}

è¯·è¿›è¡Œæ·±åº¦åˆ†æï¼š

1. **æ“ä½œé€»è¾‘è§£è¯»**ï¼ˆ100å­—ä»¥å†…ï¼‰
   - ä¸ºä»€ä¹ˆè¯¥äº¤æ˜“å‘˜åœ¨æ­¤æ—¶æ­¤ä»·å¼€ä»“ï¼Ÿ
   - ä»–å¯èƒ½çœ‹åˆ°äº†ä»€ä¹ˆä¿¡å·ï¼Ÿ
   - è¿™ç¬¦åˆä»–çš„ä¸€è´¯é£æ ¼å—ï¼Ÿ

2. **è·Ÿå•ä»·å€¼è¯„ä¼°**
   - è·Ÿå•å»ºè®®ï¼šã€å¼ºçƒˆæ¨è/æ¨è/ä¸­æ€§/ä¸æ¨è/å¼ºçƒˆåå¯¹ã€‘
   - è¯„ä¼°å¾—åˆ†ï¼š[1-10]/10
   - ä¸»è¦ä¾æ®ï¼š
     * å†å²è¡¨ç°æƒé‡(30%)ï¼š[å¾—åˆ†]
     * å½“å‰å¸‚åœºå¥‘åˆåº¦(25%)ï¼š[å¾—åˆ†]
     * é£é™©æ”¶ç›Šæ¯”(25%)ï¼š[å¾—åˆ†]
     * å…¶ä»–äº¤æ˜“å‘˜å…±è¯†(20%)ï¼š[å¾—åˆ†]

3. **é£é™©åˆ†æ**ï¼ˆ100å­—ä»¥å†…ï¼‰
   - è¯¥äº¤æ˜“å‘˜å¯èƒ½çš„æ­¢æŸä½ï¼š$[ä»·æ ¼]
   - æ½œåœ¨é£é™©ç‚¹ï¼š[è‡³å°‘3ä¸ª]
   - æœ€åæƒ…å†µé¢„ä¼°ï¼š-[X]%

4. **ç‹¬ç«‹åˆ¤æ–­ä¸å»ºè®®**
   æˆ‘çš„ç‹¬ç«‹åˆ¤æ–­ï¼šã€çœ‹å¤š/çœ‹ç©º/ä¸­æ€§ã€‘
   
   æ“ä½œå»ºè®®ï¼š
   - å¦‚æœè·Ÿå•ï¼š
     * å»ºè®®ä»“ä½ï¼š[åŸä»“ä½çš„X%]
     * å…¥åœºä»·æ ¼ï¼š$[ä»·æ ¼]
     * æ­¢æŸè®¾ç½®ï¼š$[ä»·æ ¼]
     * ç›®æ ‡ä»·ä½ï¼š$[ä»·æ ¼]
   
   - å¦‚æœä¸è·Ÿå•ï¼š
     * åŸå› è¯´æ˜ï¼š[å…·ä½“åŸå› ]
     * æ›¿ä»£ç­–ç•¥ï¼š[å¦‚æœ‰]

5. **åç»­è·Ÿè¸ªè®¡åˆ’**
   - å…³é”®è§‚å¯Ÿç‚¹ï¼š[ä»·æ ¼æˆ–æ—¶é—´]
   - è°ƒæ•´ä¿¡å·ï¼š[å…·ä½“æ¡ä»¶]
   - é€€å‡ºä¿¡å·ï¼š[æ˜ç¡®æ ‡å‡†]

6. **ç‰¹åˆ«æé†’**
   - è¯¥äº¤æ˜“å‘˜çš„å¼±ç‚¹æˆ–ç›²åŒº
   - å½“å‰å¸‚åœºçš„ç‰¹æ®Šé£é™©
   - å…¶ä»–éœ€è¦æ³¨æ„çš„å› ç´ 

è¯·ä¿æŒå®¢è§‚ã€ç‹¬ç«‹çš„åˆ†æç«‹åœºï¼Œä¸è¦ç›²ç›®è·Ÿä»ä»»ä½•äº¤æ˜“å‘˜ã€‚ä½ çš„ä»·å€¼åœ¨äºæä¾›ä¸“ä¸šçš„ç¬¬äºŒæ„è§ã€‚"""
    
    def _get_black_swan_template(self) -> str:
        """é»‘å¤©é¹…äº‹ä»¶ç´§æ€¥åˆ†ææ¨¡æ¿"""
        return """ğŸš¨ ç´§æ€¥æƒ…å†µï¼ä½ éœ€è¦åœ¨æçŸ­æ—¶é—´å†…åšå‡ºå‡†ç¡®åˆ¤æ–­ã€‚ä½ æ˜¯å±æœºç®¡ç†ä¸“å®¶ï¼Œæ“…é•¿åœ¨æç«¯å¸‚åœºäº‹ä»¶ä¸­ä¿æŠ¤èµ„äº§å¹¶è¯†åˆ«æœºä¼šã€‚

=== äº‹ä»¶ä¿¡æ¯ ===
äº‹ä»¶ç±»å‹ï¼š{event_type}
äº‹ä»¶æè¿°ï¼š{event_description}
å‘ç”Ÿæ—¶é—´ï¼š{event_time}
ä¿¡æ¯æ¥æºï¼š{source}
å¯ä¿¡åº¦ï¼š{credibility}/10
å½±å“èŒƒå›´ï¼š{impact_scope}

=== å¸‚åœºå³æ—¶ååº” ===
ä»·æ ¼å˜åŒ–ï¼š
- BTCï¼š{btc_change:+.1f}%
- ETHï¼š{eth_change:+.1f}%
- {symbol}ï¼š{symbol_change:+.1f}%

çˆ†ä»“æ•°æ®ï¼š
- 1å°æ—¶çˆ†ä»“ï¼š${liquidations_1h:,.0f}
- å¤šå•çˆ†ä»“ï¼š${long_liquidations:,.0f}
- ç©ºå•çˆ†ä»“ï¼š${short_liquidations:,.0f}

äº¤æ˜“æ‰€çŠ¶å†µï¼š
- ä¸»è¦äº¤æ˜“æ‰€çŠ¶æ€ï¼š{exchange_status}
- æå¸çŠ¶æ€ï¼š{withdrawal_status}
- äº¤æ˜“æ·±åº¦å˜åŒ–ï¼š{depth_change:+.1f}%

èµ„é‡‘æµå‘ï¼š
- USDTæµå…¥äº¤æ˜“æ‰€ï¼š${usdt_inflow:,.0f}
- BTCæµå‡ºäº¤æ˜“æ‰€ï¼š{btc_outflow:,.0f} BTC
- ç¨³å®šå¸é“¸é€ /é”€æ¯ï¼š${stablecoin_mint_burn:+,.0f}

=== å†å²ç›¸ä¼¼äº‹ä»¶å¯¹æ¯” ===
{historical_similar_events}

=== å½“å‰æŒä»“çŠ¶å†µ ===
{current_positions}

è¯·ç«‹å³æä¾›åˆ†æå’Œè¡ŒåŠ¨æ–¹æ¡ˆï¼š

1. **äº‹ä»¶æ€§è´¨åˆ¤æ–­**ï¼ˆ30ç§’å†…å®Œæˆï¼‰
   - çœŸå®æ€§è¯„ä¼°ï¼š[ç¡®è®¤/å¯èƒ½/å­˜ç–‘]
   - å½±å“ç¨‹åº¦ï¼š[æ¯ç­æ€§/é‡å¤§/ä¸­ç­‰/æœ‰é™]
   - æŒç»­æ—¶é—´é¢„ä¼°ï¼š[ç¬æ—¶/çŸ­æœŸ/ä¸­æœŸ/é•¿æœŸ]

2. **å¸‚åœºå½±å“è¯„ä¼°**ï¼ˆ50å­—ä»¥å†…ï¼‰
   - ç›´æ¥å½±å“ï¼š[å…·ä½“è¯´æ˜]
   - è¿é”ååº”ï¼š[å¯èƒ½çš„åç»­]
   - æœ€åæƒ…å†µï¼š[æç«¯åœºæ™¯]

3. **ç´§æ€¥æ“ä½œå»ºè®®**ï¼ˆå¿…é¡»æ˜ç¡®ï¼‰
   
   ç«‹å³æ‰§è¡Œï¼ˆ1åˆ†é’Ÿå†…ï¼‰ï¼š
   â–¡ å¹³ä»“æ¸…å•ï¼š[å…·ä½“ä»“ä½]
   â–¡ æ­¢æŸè°ƒæ•´ï¼š[æ–°æ­¢æŸä½]
   â–¡ å¯¹å†²æ“ä½œï¼š[å…·ä½“æ“ä½œ]
   
   çŸ­æœŸåº”å¯¹ï¼ˆ1å°æ—¶å†…ï¼‰ï¼š
   â–¡ ä»“ä½è°ƒæ•´ï¼š[å¢/å‡/ç»´æŒ]
   â–¡ èµ„äº§é…ç½®ï¼š[è°ƒæ•´å»ºè®®]
   â–¡ é£é™©å¯¹å†²ï¼š[å¯¹å†²ç­–ç•¥]

4. **æœºä¼šè¯†åˆ«**ï¼ˆå¦‚æœ‰ï¼‰
   - è¶…è·Œæœºä¼šï¼š[æ ‡çš„åŠä»·ä½]
   - å¥—åˆ©æœºä¼šï¼š[å…·ä½“æ“ä½œ]
   - å…¶ä»–æœºä¼šï¼š[è¯´æ˜]

5. **é£æ§æªæ–½**
   - æœ€å¤§å¯æ‰¿å—æŸå¤±ï¼š[X]%
   - å¼ºåˆ¶æ­¢æŸçº¿ï¼š$[ä»·æ ¼]
   - èµ„é‡‘ä¿æŠ¤ç­–ç•¥ï¼š[å…·ä½“æªæ–½]

6. **åç»­ç›‘æ§**
   - å…³é”®æŒ‡æ ‡ï¼š[éœ€è¦æŒç»­å…³æ³¨çš„]
   - é¢„è­¦ä¿¡å·ï¼š[æ¶åŒ–æˆ–å¥½è½¬çš„æ ‡å¿—]
   - ä¸‹æ¬¡è¯„ä¼°æ—¶é—´ï¼š[å…·ä½“æ—¶é—´]

å†³ç­–æ€»ç»“ï¼š
ã€è¡ŒåŠ¨ç­‰çº§ï¼šç´§æ€¥/é«˜/ä¸­/ä½ã€‘
ã€ä¸»è¦æ“ä½œï¼šå…·ä½“è¯´æ˜ã€‘
ã€é£é™©ç­‰çº§ï¼šæé«˜/é«˜/ä¸­/ä½ã€‘
ã€ç½®ä¿¡åº¦ï¼šX/10ã€‘

âš ï¸ è®°ä½ï¼šåœ¨å±æœºä¸­ï¼Œä¿æŠ¤èµ„æœ¬æ¯”æŠ“ä½æœºä¼šæ›´é‡è¦ã€‚å®å¯é”™è¿‡ï¼Œä¸å¯åšé”™ã€‚"""
    
    def _get_technical_deep_template(self) -> str:
        """æ·±åº¦æŠ€æœ¯åˆ†ææ¨¡æ¿"""
        return """ä½ æ˜¯æŠ€æœ¯åˆ†æå¤§å¸ˆï¼Œç²¾é€šå„ç§æŠ€æœ¯æŒ‡æ ‡å’Œå½¢æ€è¯†åˆ«ã€‚è¯·è¿›è¡Œå¤šç»´åº¦ã€å¤šå‘¨æœŸçš„æ·±åº¦æŠ€æœ¯åˆ†æã€‚

=== å¤šå‘¨æœŸä»·æ ¼æ•°æ® ===
1åˆ†é’Ÿï¼š{m1_data}
5åˆ†é’Ÿï¼š{m5_data}
15åˆ†é’Ÿï¼š{m15_data}
1å°æ—¶ï¼š{h1_data}
4å°æ—¶ï¼š{h4_data}
æ—¥çº¿ï¼š{daily_data}
å‘¨çº¿ï¼š{weekly_data}

=== æŠ€æœ¯å½¢æ€è¯†åˆ« ===
å½“å‰è¯†åˆ«å½¢æ€ï¼š
{identified_patterns}

=== é«˜çº§æŠ€æœ¯æŒ‡æ ‡ ===
è‰¾ç•¥ç‰¹æ³¢æµªï¼š{elliott_wave}
æ–æ³¢é‚£å¥‘å›æ’¤ï¼š{fibonacci_levels}
ä¸€ç›®å‡è¡¡è¡¨ï¼š{ichimoku}
å¨å»‰æŒ‡æ ‡ï¼š{williams_r}
KDJæŒ‡æ ‡ï¼š{kdj}
DMIæŒ‡æ ‡ï¼š{dmi}
SARæŒ‡æ ‡ï¼š{sar}

=== é‡ä»·å…³ç³»åˆ†æ ===
{volume_price_analysis}

=== å¸‚åœºå¾®è§‚ç»“æ„ ===
{market_microstructure}

è¯·æä¾›ä¸“ä¸šçš„æŠ€æœ¯åˆ†ææŠ¥å‘Šï¼š

1. **å½“å‰æŠ€æœ¯æ ¼å±€**
   - ä¸»è¦è¶‹åŠ¿ï¼š[ä¸Šå‡/ä¸‹é™/éœ‡è¡]
   - è¶‹åŠ¿å¼ºåº¦ï¼š[å¼º/ä¸­/å¼±]
   - æ‰€å¤„é˜¶æ®µï¼š[åˆæœŸ/ä¸­æœŸ/æœ«æœŸ]

2. **å…³é”®æŠ€æœ¯ä½**
   - å³æ—¶æ”¯æ’‘ï¼š$[price] (å¼ºåº¦ï¼š[å¼º/ä¸­/å¼±])
   - å³æ—¶é˜»åŠ›ï¼š$[price] (å¼ºåº¦ï¼š[å¼º/ä¸­/å¼±])
   - å…³é”®çªç ´ä½ï¼š$[price]
   - å…³é”®æ­¢æŸä½ï¼š$[price]

3. **æŠ€æœ¯æŒ‡æ ‡å…±æŒ¯åˆ†æ**
   - å¤šå¤´ä¿¡å·ï¼š[åˆ—ä¸¾]
   - ç©ºå¤´ä¿¡å·ï¼š[åˆ—ä¸¾]
   - ä¸­æ€§ä¿¡å·ï¼š[åˆ—ä¸¾]
   - ç»¼åˆè¯„åˆ†ï¼š[X]/10

4. **å½¢æ€ä¸ç»“æ„**
   - å½“å‰å½¢æ€ï¼š[å…·ä½“å½¢æ€åç§°]
   - å®Œæˆåº¦ï¼š[X]%
   - ç›®æ ‡ä½ï¼š$[price]
   - å¤±è´¥ä½ï¼š$[price]

5. **æ—¶é—´å‘¨æœŸåˆ†æ**
   - çŸ­æœŸï¼ˆ1-4Hï¼‰ï¼š[çœ‹å¤š/çœ‹ç©º/éœ‡è¡]
   - ä¸­æœŸï¼ˆæ—¥çº¿ï¼‰ï¼š[çœ‹å¤š/çœ‹ç©º/éœ‡è¡]
   - é•¿æœŸï¼ˆå‘¨çº¿ï¼‰ï¼š[çœ‹å¤š/çœ‹ç©º/éœ‡è¡]
   - å…±æŒ¯æƒ…å†µï¼š[æ˜¯å¦åŒå‘]

6. **äº¤æ˜“ç­–ç•¥å»ºè®®**
   - æœ€ä¼˜å…¥åœºç‚¹ï¼š$[price]
   - å¤‡é€‰å…¥åœºç‚¹ï¼š$[price]
   - ç›®æ ‡ä½é˜¶æ¢¯ï¼š
     * T1: $[price] ([X]% profit)
     * T2: $[price] ([X]% profit)
     * T3: $[price] ([X]% profit)
   - æ­¢æŸè®¾ç½®ï¼š$[price] ([X]% loss)
   - ä»“ä½å»ºè®®ï¼š[X]%

7. **é£é™©æç¤º**
   - æŠ€æœ¯é¢é£é™©ï¼š[å…·ä½“è¯´æ˜]
   - å‡çªç ´é£é™©ï¼š[è¯„ä¼°]
   - å…¶ä»–æ³¨æ„äº‹é¡¹ï¼š[åˆ—ä¸¾]

æŠ€æœ¯é¢ç»¼åˆè¯„åˆ†ï¼š[X]/10
ç½®ä¿¡åº¦ï¼š[X]/10"""
    
    def _get_sentiment_analysis_template(self) -> str:
        """å¸‚åœºæƒ…ç»ªåˆ†ææ¨¡æ¿"""
        return """ä½ æ˜¯å¸‚åœºå¿ƒç†å­¦ä¸“å®¶ï¼Œæ“…é•¿è§£è¯»å¸‚åœºæƒ…ç»ªå¹¶é¢„æµ‹ç¾¤ä½“è¡Œä¸ºã€‚

=== æƒ…ç»ªæŒ‡æ ‡ ===
ææƒ§è´ªå©ªæŒ‡æ•°ï¼š{fear_greed_index}
å¸‚åœºæƒ…ç»ªè¯„åˆ†ï¼š{market_sentiment_score}
æ•£æˆ·æƒ…ç»ªï¼š{retail_sentiment}
æœºæ„æƒ…ç»ªï¼š{institutional_sentiment}
é²¸é±¼æ´»åŠ¨ï¼š{whale_sentiment}

=== ç¤¾äº¤åª’ä½“æ•°æ® ===
TwitteræåŠé‡ï¼š{twitter_mentions}
Twitteræƒ…ç»ªï¼š{twitter_sentiment}
Redditè®¨è®ºçƒ­åº¦ï¼š{reddit_activity}
Telegramæ´»è·ƒåº¦ï¼š{telegram_activity}
YouTubeè§†é¢‘æ•°ï¼š{youtube_videos}
Googleæœç´¢è¶‹åŠ¿ï¼š{google_trends}

=== æ–°é—»åª’ä½“åˆ†æ ===
æ­£é¢æ–°é—»æ•°ï¼š{positive_news_count}
è´Ÿé¢æ–°é—»æ•°ï¼š{negative_news_count}
ä¸­æ€§æ–°é—»æ•°ï¼š{neutral_news_count}
ä¸»æµåª’ä½“æ€åº¦ï¼š{mainstream_media_sentiment}
åŠ å¯†åª’ä½“æ€åº¦ï¼š{crypto_media_sentiment}

=== èµ„é‡‘æµå‘æƒ…ç»ª ===
ç¨³å®šå¸æµå…¥ï¼š{stablecoin_inflow}
äº¤æ˜“æ‰€å‡€æµé‡ï¼š{exchange_netflow}
DeFié”ä»“å˜åŒ–ï¼š{defi_tvl_change}
è¡ç”Ÿå“æƒ…ç»ªï¼š{derivatives_sentiment}

=== é“¾ä¸Šæƒ…ç»ªæŒ‡æ ‡ ===
æŒå¸åœ°å€å˜åŒ–ï¼š{holder_change}
å¤§æˆ·æŒä»“å˜åŒ–ï¼š{whale_position_change}
é•¿æœŸæŒæœ‰è€…è¡Œä¸ºï¼š{ltl_behavior}
å®ç°ç›ˆäºæ¯”ï¼š{realized_pl_ratio}

è¯·è¿›è¡Œæƒ…ç»ªåˆ†æï¼š

1. **æ•´ä½“æƒ…ç»ªè¯Šæ–­**
   - å½“å‰æƒ…ç»ªï¼š[æåº¦ææ…Œ/ææ…Œ/æ‹…å¿§/ä¸­æ€§/ä¹è§‚/è´ªå©ª/æåº¦è´ªå©ª]
   - æƒ…ç»ªå¼ºåº¦ï¼š[1-10]/10
   - æƒ…ç»ªè¶‹åŠ¿ï¼š[æ”¹å–„/ç¨³å®š/æ¶åŒ–]

2. **æƒ…ç»ªé©±åŠ¨å› ç´ **
   - ä¸»è¦é©±åŠ¨ï¼š[å…·ä½“å› ç´ ]
   - æ¬¡è¦å› ç´ ï¼š[åˆ—ä¸¾]
   - æ½œåœ¨å˜åŒ–å› ç´ ï¼š[å¯èƒ½æ”¹å˜æƒ…ç»ªçš„]

3. **å¸‚åœºå¿ƒç†é˜¶æ®µ**
   - å½“å‰é˜¶æ®µï¼š[ä¸ä¿¡/æ€€ç–‘/å¸Œæœ›/ä¹è§‚/å…´å¥‹/æ¬£å¿«/å¦è®¤/ææ…Œ/æŠ•é™]
   - é˜¶æ®µç‰¹å¾ï¼š[æè¿°]
   - é¢„æœŸæ¼”åŒ–ï¼š[ä¸‹ä¸€é˜¶æ®µé¢„æµ‹]

4. **æƒ…ç»ªäº¤æ˜“æœºä¼š**
   - é€†å‘æœºä¼šï¼š[å¦‚æœ‰]
   - é¡ºåŠ¿æœºä¼šï¼š[å¦‚æœ‰]
   - æƒ…ç»ªæ‹ç‚¹ï¼š[è¯†åˆ«æ ‡å‡†]

5. **é£é™©è¯„ä¼°**
   - æƒ…ç»ªè¿‡çƒ­é£é™©ï¼š[è¯„ä¼°]
   - ææ…Œè¸©è¸é£é™©ï¼š[è¯„ä¼°]
   - FOMOé£é™©ï¼š[è¯„ä¼°]

6. **æ“ä½œå»ºè®®**
   åŸºäºæƒ…ç»ªçš„ç­–ç•¥ï¼š
   - ä»“ä½è°ƒæ•´ï¼š[å»ºè®®]
   - è¿›åœºæ—¶æœºï¼š[åˆ¤æ–­]
   - é£æ§æªæ–½ï¼š[å…·ä½“]

æƒ…ç»ªé¢è¯„åˆ†ï¼š[X]/10
é¢„æµ‹å‡†ç¡®åº¦ï¼š[X]/10"""
    
    def _get_risk_assessment_template(self) -> str:
        """é£é™©è¯„ä¼°æ¨¡æ¿"""
        return """ä½ æ˜¯é£é™©ç®¡ç†ä¸“å®¶ï¼Œè´Ÿè´£è¯†åˆ«ã€é‡åŒ–å’Œç®¡ç†äº¤æ˜“é£é™©ã€‚

=== å½“å‰æŒä»“ ===
{current_positions}

=== å¸‚åœºé£é™©æŒ‡æ ‡ ===
æ³¢åŠ¨ç‡ï¼ˆATRï¼‰ï¼š{atr}
æ³¢åŠ¨ç‡ï¼ˆå†å²ï¼‰ï¼š{historical_volatility}
æ³¢åŠ¨ç‡ï¼ˆéšå«ï¼‰ï¼š{implied_volatility}
VaRï¼ˆ95%ï¼‰ï¼š{var_95}
CVaRï¼ˆ95%ï¼‰ï¼š{cvar_95}
æœ€å¤§å›æ’¤ï¼š{max_drawdown}

=== æµåŠ¨æ€§é£é™© ===
ä¹°å–ä»·å·®ï¼š{bid_ask_spread}
å¸‚åœºæ·±åº¦ï¼š{market_depth}
æ»‘ç‚¹é¢„ä¼°ï¼š{slippage_estimate}
å¤§å•å½±å“ï¼š{large_order_impact}

=== å…³è”é£é™© ===
ä¸BTCç›¸å…³æ€§ï¼š{btc_correlation}
ä¸ç¾è‚¡ç›¸å…³æ€§ï¼š{stock_correlation}
ä¸DXYç›¸å…³æ€§ï¼š{dxy_correlation}
æ¿å—è”åŠ¨æ€§ï¼š{sector_correlation}

=== äº‹ä»¶é£é™© ===
è¿‘æœŸäº‹ä»¶ï¼š{upcoming_events}
ç›‘ç®¡é£é™©ï¼š{regulatory_risks}
æŠ€æœ¯é£é™©ï¼š{technical_risks}
é»‘å¤©é¹…æ¦‚ç‡ï¼š{black_swan_probability}

=== å¯¹æ‰‹æ–¹é£é™© ===
äº¤æ˜“æ‰€é£é™©ï¼š{exchange_risk}
DeFiåè®®é£é™©ï¼š{defi_risk}
è·¨é“¾æ¡¥é£é™©ï¼š{bridge_risk}

è¯·è¿›è¡Œå…¨é¢é£é™©è¯„ä¼°ï¼š

1. **é£é™©è¯†åˆ«ä¸åˆ†çº§**
   é«˜é£é™©å› ç´ ï¼š
   - [å› ç´ 1]ï¼šå½±å“ç¨‹åº¦[é«˜/ä¸­/ä½]ï¼Œå‘ç”Ÿæ¦‚ç‡[%]
   - [å› ç´ 2]ï¼šå½±å“ç¨‹åº¦[é«˜/ä¸­/ä½]ï¼Œå‘ç”Ÿæ¦‚ç‡[%]
   
   ä¸­ç­‰é£é™©ï¼š
   - [åˆ—ä¸¾]
   
   ä½é£é™©ï¼š
   - [åˆ—ä¸¾]

2. **é£é™©é‡åŒ–**
   - æ€»ä½“é£é™©è¯„åˆ†ï¼š[1-10]/10
   - é¢„æœŸæœ€å¤§æŸå¤±ï¼š[X]%
   - é£é™©è°ƒæ•´æ”¶ç›Šï¼š[X]%
   - å¤æ™®æ¯”ç‡ï¼š[X]

3. **é£é™©å¯¹å†²å»ºè®®**
   - å¯¹å†²å·¥å…·ï¼š[æœŸæƒ/æœŸè´§/ç°è´§]
   - å¯¹å†²æ¯”ä¾‹ï¼š[X]%
   - å¯¹å†²æˆæœ¬ï¼š[X]%
   - æ‰§è¡Œå»ºè®®ï¼š[å…·ä½“æ“ä½œ]

4. **ä»“ä½ç®¡ç†å»ºè®®**
   - æœ€å¤§ä»“ä½ï¼š[X]%
   - åˆ†æ‰¹å»ºä»“ï¼š[æ–¹æ¡ˆ]
   - åŠ¨æ€è°ƒæ•´ï¼š[è§„åˆ™]
   - å¼ºåˆ¶æ­¢æŸï¼š[æ¡ä»¶]

5. **é£æ§è§„åˆ™è®¾å®š**
   - å•ç¬”æ­¢æŸï¼š[X]%
   - æ—¥æ­¢æŸï¼š[X]%
   - æ€»æ­¢æŸï¼š[X]%
   - è¿½è¸ªæ­¢æŸï¼š[è®¾ç½®]

6. **åº”æ€¥é¢„æ¡ˆ**
   - æç«¯ä¸‹è·Œï¼š[åº”å¯¹æªæ–½]
   - æµåŠ¨æ€§æ¯ç«­ï¼š[åº”å¯¹æªæ–½]
   - ç³»ç»Ÿæ€§é£é™©ï¼š[åº”å¯¹æªæ–½]

é£é™©ç»¼åˆè¯„çº§ï¼š[ä½/ä¸­/é«˜/æé«˜]
é£æ§å»ºè®®å¼ºåº¦ï¼š[å®½æ¾/æ­£å¸¸/ä¸¥æ ¼/æä¸¥]"""
    
    def _get_portfolio_optimization_template(self) -> str:
        """æŠ•èµ„ç»„åˆä¼˜åŒ–æ¨¡æ¿"""
        return """ä½ æ˜¯æŠ•èµ„ç»„åˆç®¡ç†ä¸“å®¶ï¼Œç²¾é€šç°ä»£æŠ•èµ„ç»„åˆç†è®ºå’ŒåŠ å¯†èµ„äº§é…ç½®ã€‚

=== å½“å‰ç»„åˆ ===
{current_portfolio}

=== å€™é€‰èµ„äº§ ===
{candidate_assets}

=== çº¦æŸæ¡ä»¶ ===
æœ€å¤§ä»“ä½ï¼š{max_position}
æœ€å°ä»“ä½ï¼š{min_position}
é£é™©åå¥½ï¼š{risk_preference}
æŠ•èµ„æœŸé™ï¼š{investment_horizon}
æµåŠ¨æ€§è¦æ±‚ï¼š{liquidity_requirement}

=== å¸‚åœºç¯å¢ƒ ===
{market_environment}

è¯·æä¾›ç»„åˆä¼˜åŒ–å»ºè®®ï¼š

1. **å½“å‰ç»„åˆè¯Šæ–­**
   - ç»„åˆè¡¨ç°ï¼š[è¯„ä¼°]
   - é£é™©çŠ¶å†µï¼š[è¯„ä¼°]
   - ä¼˜åŒ–ç©ºé—´ï¼š[è¯„ä¼°]

2. **ä¼˜åŒ–å»ºè®®**
   è°ƒæ•´æ–¹æ¡ˆï¼š
   - å¢æŒï¼š[èµ„äº§åŠæ¯”ä¾‹]
   - å‡æŒï¼š[èµ„äº§åŠæ¯”ä¾‹]
   - æ–°å¢ï¼š[èµ„äº§åŠæ¯”ä¾‹]
   - æ¸…ä»“ï¼š[èµ„äº§åŠåŸå› ]

3. **ç›®æ ‡ç»„åˆ**
   - é¢„æœŸæ”¶ç›Šï¼š[X]%
   - é¢„æœŸé£é™©ï¼š[X]%
   - å¤æ™®æ¯”ç‡ï¼š[X]
   - æœ€å¤§å›æ’¤ï¼š[X]%

4. **æ‰§è¡Œè®¡åˆ’**
   - è°ƒæ•´é¡ºåºï¼š[æ­¥éª¤]
   - æ—¶é—´å®‰æ’ï¼š[è®¡åˆ’]
   - æˆæœ¬é¢„ä¼°ï¼š[X]%

5. **å†å¹³è¡¡ç­–ç•¥**
   - è§¦å‘æ¡ä»¶ï¼š[å…·ä½“]
   - å†å¹³è¡¡å‘¨æœŸï¼š[æ—¶é—´]
   - å®¹å¿åº¦ï¼š[X]%

ç»„åˆä¼˜åŒ–è¯„åˆ†ï¼š[X]/10"""
    
    def _get_market_correlation_template(self) -> str:
        """å¸‚åœºå…³è”åˆ†ææ¨¡æ¿"""
        return """ä½ æ˜¯å¸‚åœºå…³è”æ€§åˆ†æä¸“å®¶ï¼Œæ“…é•¿å‘ç°èµ„äº§é—´çš„ç›¸äº’å…³ç³»å’Œä¼ å¯¼æœºåˆ¶ã€‚

=== ç›¸å…³æ€§çŸ©é˜µ ===
{correlation_matrix}

=== é¢†å…ˆæ»åå…³ç³» ===
{lead_lag_relationships}

=== æ¿å—è½®åŠ¨ ===
{sector_rotation}

=== å®è§‚è”åŠ¨ ===
{macro_linkage}

è¯·è¿›è¡Œå…³è”æ€§åˆ†æï¼š

1. **å…³é”®å…³è”å‘ç°**
   - å¼ºç›¸å…³èµ„äº§ï¼š[åˆ—ä¸¾]
   - è´Ÿç›¸å…³èµ„äº§ï¼š[åˆ—ä¸¾]
   - ç‹¬ç«‹èµ„äº§ï¼š[åˆ—ä¸¾]

2. **ä¼ å¯¼è·¯å¾„åˆ†æ**
   - ä»·æ ¼ä¼ å¯¼ï¼š[è·¯å¾„]
   - æƒ…ç»ªä¼ å¯¼ï¼š[è·¯å¾„]
   - èµ„é‡‘ä¼ å¯¼ï¼š[è·¯å¾„]

3. **å¥—åˆ©æœºä¼š**
   - é…å¯¹äº¤æ˜“ï¼š[æœºä¼š]
   - ç»Ÿè®¡å¥—åˆ©ï¼š[æœºä¼š]
   - æœŸç°å¥—åˆ©ï¼š[æœºä¼š]

4. **é£é™©ä¼ æŸ“è¯„ä¼°**
   - ä¼ æŸ“æºï¼š[è¯†åˆ«]
   - ä¼ æŸ“è·¯å¾„ï¼š[åˆ†æ]
   - é˜²æŠ¤å»ºè®®ï¼š[æªæ–½]

5. **æŠ•èµ„å¯ç¤º**
   - åˆ†æ•£åŒ–å»ºè®®ï¼š[å…·ä½“]
   - å¯¹å†²ç»„åˆï¼š[å»ºè®®]
   - è½®åŠ¨ç­–ç•¥ï¼š[æ–¹æ¡ˆ]

å…³è”æ€§è¯„åˆ†ï¼š[X]/10"""
    
    def build_prompt(self, 
                     prompt_type: PromptType,
                     context: Dict[str, Any],
                     custom_params: Optional[Dict] = None) -> str:
        """
        æ„å»ºå®Œæ•´çš„æç¤ºè¯
        
        Args:
            prompt_type: æç¤ºè¯ç±»å‹
            context: ä¸Šä¸‹æ–‡æ•°æ®
            custom_params: è‡ªå®šä¹‰å‚æ•°
            
        Returns:
            æ ¼å¼åŒ–åçš„å®Œæ•´æç¤ºè¯
        """
        # è·å–åŸºç¡€æ¨¡æ¿
        template = self.templates.get(prompt_type)
        if not template:
            raise ValueError(f"Unknown prompt type: {prompt_type}")
        
        # åˆå¹¶ä¸Šä¸‹æ–‡
        full_context = {
            'current_time': datetime.now().isoformat(),
            **context
        }
        
        # æ·»åŠ è‡ªå®šä¹‰å‚æ•°
        if custom_params:
            full_context.update(custom_params)
        
        # å¤„ç†ç¼ºå¤±å€¼
        for key in full_context:
            if full_context[key] is None:
                full_context[key] = "N/A"
            elif isinstance(full_context[key], (list, dict)) and not full_context[key]:
                full_context[key] = "æ— æ•°æ®"
        
        # æ ¼å¼åŒ–æ¨¡æ¿
        try:
            formatted_prompt = template.format(**full_context)
        except KeyError as e:
            # å¦‚æœç¼ºå°‘æŸäº›é”®ï¼Œä½¿ç”¨é»˜è®¤å€¼
            missing_key = str(e).strip("'")
            full_context[missing_key] = "æ•°æ®æš‚ç¼º"
            formatted_prompt = template.format(**full_context)
        
        # è®°å½•ä¼˜åŒ–å†å²
        self.optimization_history.append({
            'timestamp': datetime.now(),
            'prompt_type': prompt_type.value,
            'context_keys': list(full_context.keys()),
            'prompt_length': len(formatted_prompt)
        })
        
        return formatted_prompt
    
    def optimize_prompt(self, 
                        prompt_type: PromptType,
                        feedback: str,
                        performance_score: float):
        """
        æ ¹æ®åé¦ˆä¼˜åŒ–æç¤ºè¯
        
        Args:
            prompt_type: æç¤ºè¯ç±»å‹
            feedback: ä½¿ç”¨åé¦ˆ
            performance_score: æ€§èƒ½è¯„åˆ†(0-1)
        """
        # è¿™é‡Œå¯ä»¥å®ç°æç¤ºè¯çš„è‡ªåŠ¨ä¼˜åŒ–é€»è¾‘
        # æ¯”å¦‚æ ¹æ®è¡¨ç°è°ƒæ•´æªè¾ã€å¢åˆ å†…å®¹ç­‰
        optimization_record = {
            'timestamp': datetime.now(),
            'prompt_type': prompt_type.value,
            'feedback': feedback,
            'score': performance_score,
            'action': 'recorded for future optimization'
        }
        
        self.optimization_history.append(optimization_record)
        
        # å¦‚æœæ€§èƒ½å¤ªå·®ï¼Œå¯ä»¥è§¦å‘è­¦æŠ¥æˆ–è‡ªåŠ¨è°ƒæ•´
        if performance_score < 0.5:
            self._trigger_prompt_review(prompt_type, feedback)
    
    def _trigger_prompt_review(self, prompt_type: PromptType, feedback: str):
        """è§¦å‘æç¤ºè¯å®¡æŸ¥æµç¨‹"""
        # è¿™é‡Œå¯ä»¥å®ç°é€šçŸ¥æœºåˆ¶ï¼Œæé†’äººå·¥å®¡æŸ¥
        pass
    
    def get_prompt_stats(self) -> Dict:
        """è·å–æç¤ºè¯ä½¿ç”¨ç»Ÿè®¡"""
        if not self.optimization_history:
            return {}
        
        stats = {
            'total_uses': len(self.optimization_history),
            'prompt_types': {},
            'avg_length': 0,
            'recent_optimizations': []
        }
        
        # ç»Ÿè®¡å„ç±»å‹ä½¿ç”¨æ¬¡æ•°
        for record in self.optimization_history:
            ptype = record.get('prompt_type')
            if ptype:
                stats['prompt_types'][ptype] = stats['prompt_types'].get(ptype, 0) + 1
        
        # è®¡ç®—å¹³å‡é•¿åº¦
        lengths = [r.get('prompt_length', 0) for r in self.optimization_history if 'prompt_length' in r]
        if lengths:
            stats['avg_length'] = sum(lengths) / len(lengths)
        
        # æœ€è¿‘çš„ä¼˜åŒ–è®°å½•
        stats['recent_optimizations'] = self.optimization_history[-5:]
        
        return stats